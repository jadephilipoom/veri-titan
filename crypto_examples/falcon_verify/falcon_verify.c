#include <stddef.h>
#include <stdint.h>
#include <stdio.h>

#define PQCLEAN_FALCON512_CLEAN_CRYPTO_SECRETKEYBYTES   1281
#define PQCLEAN_FALCON512_CLEAN_CRYPTO_PUBLICKEYBYTES   897
#define PQCLEAN_FALCON512_CLEAN_CRYPTO_BYTES            690

/*
 * Required sizes of the temporary buffer (in bytes).
 *
 * This size is 28*2^logn bytes, except for degrees 2 and 4 (logn = 1
 * or 2) where it is slightly greater.
 */
#define FALCON_KEYGEN_TEMP_9    14336

/* ===================================================================== */
/*
 * Constants for NTT.
 *
 *   n = 2^logn  (2 <= n <= 1024)
 *   phi = X^n + 1
 *   q = 12289
 *   q0i = -1/q mod 2^16
 *   R = 2^16 mod q
 *   R2 = 2^32 mod q
 */

#define Q     12289
#define Q0I   12287
#define R      4091
#define R2    10952

/* pre-computed inputs for verify_raw */
static const uint16_t hm[] = {3093, 11131, 1969, 7903, 3546, 6688, 3256, 12227, 1776, 3893, 1933, 3057, 951, 11521, 719, 5559, 2616, 7485, 2520, 4324, 9304, 7297, 10463, 4857, 8218, 7575, 7753, 7063, 3290, 7809, 6643, 6415, 6168, 5521, 8683, 5876, 5951, 9355, 11329, 8713, 935, 7986, 7916, 1591, 11589, 7939, 5887, 3016, 9787, 11366, 8490, 7538, 433, 3414, 10220, 7056, 3179, 5340, 10901, 7777, 2082, 3979, 1192, 11983, 8507, 11934, 915, 12242, 11650, 3840, 10324, 4375, 7043, 289, 4424, 473, 9676, 7229, 6662, 2168, 12281, 8344, 4898, 10345, 6586, 3122, 11117, 5833, 8219, 1630, 93, 8995, 9687, 58, 8130, 3969, 10656, 4481, 3581, 10946, 8299, 3479, 2662, 61, 3069, 7167, 11329, 9986, 11176, 6853, 4429, 4624, 10060, 4998, 6071, 10090, 5265, 1050, 2195, 8081, 6276, 5464, 11946, 1265, 2383, 1370, 5571, 7463, 12161, 9127, 9037, 2829, 3078, 4343, 9717, 3301, 9306, 7389, 6107, 5894, 6124, 10037, 6505, 7188, 518, 1259, 1899, 5623, 11012, 11331, 5390, 11052, 10017, 9532, 10278, 2958, 1667, 8204, 9669, 10738, 10488, 2084, 5107, 1462, 8765, 6116, 8347, 3096, 747, 3440, 10906, 2331, 3130, 3111, 7493, 6192, 903, 10143, 2507, 10671, 5104, 538, 10426, 9834, 9820, 8320, 1424, 6485, 10669, 3753, 8721, 947, 9154, 561, 8433, 8717, 759, 6814, 4518, 9651, 7353, 1200, 196, 2140, 12062, 1650, 5464, 10724, 9791, 12052, 6030, 10314, 12255, 4768, 10626, 1509, 11058, 12080, 11296, 11598, 10647, 6789, 6516, 9975, 6578, 4190, 2511, 3661, 1056, 3026, 2373, 1333, 3093, 6790, 8405, 6499, 1205, 11558, 2596, 5950, 1562, 9067, 10073, 5803, 6192, 12033, 11471, 1968, 6715, 6481, 774, 6080, 9638, 10245, 2732, 4836, 3799, 242, 2233, 3719, 9532, 9466, 6542, 2627, 8503, 7180, 4286, 1635, 8831, 2862, 7370, 11325, 2045, 3126, 2514, 557, 6429, 3217, 11656, 2844, 8859, 6098, 7236, 4093, 7122, 5916, 10611, 10468, 6514, 1137, 3439, 7020, 4257, 6317, 5469, 5352, 4159, 10289, 1011, 3639, 8065, 7364, 10091, 4874, 7752, 10251, 8790, 4616, 2329, 4654, 5832, 12008, 530, 320, 2060, 12163, 8183, 2830, 3367, 674, 6130, 9503, 8067, 8714, 6638, 11828, 7543, 9209, 10420, 9538, 3926, 11817, 4521, 2270, 12116, 11013, 8317, 2654, 12134, 4488, 10843, 500, 4189, 5459, 6729, 2117, 4292, 838, 4037, 9316, 5600, 5300, 11891, 484, 7235, 7430, 6061, 3998, 1589, 6366, 2506, 1671, 5856, 10118, 9854, 7958, 9969, 2318, 1331, 9572, 7418, 9039, 6089, 4518, 3042, 11205, 5326, 11278, 1758, 11044, 3758, 3174, 11125, 9546, 320, 1465, 2547, 11154, 8562, 1418, 8197, 4394, 12216, 5223, 9970, 3548, 5317, 11775, 4952, 10997, 9311, 6515, 6885, 7880, 6755, 8491, 11244, 811, 8427, 252, 3062, 5349, 10338, 3354, 7906, 6092, 3125, 10299, 11224, 7630, 11273, 5614, 4165, 8113, 5089, 4451, 2721, 1151, 8399, 6275, 2365, 11162, 11117, 8111, 5902, 2401, 7206, 6112, 9985, 1326, 2992, 12122, 1554, 6617, 5074, 8810, 3362, 3154, 9733, 11506, 3382, 7882, 10243, 7362, 6095, 4183, 3725, 17, 562, 12279, 5268, 10427, 3714, 6757, 4296, 10396, 3993, 10299, 11414, 558, 10219, 10064, 499, 11226, 2163, 10550, 3678, 5743, 292, 11207, 6038, 6042, 2114, 1872, 2308, 11055, 3235, 4863, 2748, 1730, 5024, 12045, 2324, 6920, 8268, 8593, 6643, 4915, 781, 5747, 6542, 1641, 4534, 1742, 8329, 4529, 6869, 4822, 10665, 8760, 193, 10962, 11696, 10087, 9423, 8207, 7922, 89, 3391, 5263, 2994, 1892, 1876, 10868, 9498, 9522, 2535, 3804, 5320, 3440, 1029, 11177, 5369, 4562, 9622, 10200, 9328, 11786, 6952, 89, 10951, 11038, 5674, 11054, 530, 9118, 2519, 8410, 6677, 2027, 6571, 1377, 10851, 11102, 12152, 3914, 3146, 9282, 3870, 7490, 5961, 2646, 1996, 7850, 7597, 10420, 5250, 10036, 68, 9916, 3354, 11037, 2079, 5715, 2140, 10687, 10019, 3655, 6028, 419, 10417, 3375, 10334, 5859, 3711, 5382, 8853, 11340, 10788, 2063, 11778, 10583, 4553, 968, 8821, 6296, 2199, 1164, 7448, 7556, 4045, 951, 6230, 10995, 1730, 3683, 1136, 9016, 8542, 1768, 10446, 735, 7804, 8697, 4537, 8740, 8273, 2023, 8900, 4717, 8709, 11877, 3564, 6102, 7002, 6234, 6314, 3229, 2300, 4117, 11914, 6899, 956, 2575, 6908, 11157, 9528, 1122, 911, 5203, 4859, 7420, 978, 2733, 3041, 7828, 5987, 9608, 2412, 4092, 9594, 1645, 463, 7642, 11038, 4125, 1832, 11682, 7358, 9251, 10936, 8666, 9913, 2029, 2744, 5149, 4078, 1580, 5586, 9378, 1181, 3790, 4462, 1959, 1206, 4461, 799, 871, 4815, 10726, 11796, 4222, 8500, 398, 1465, 4952, 9932, 8719, 1933, 6480, 9746, 1055, 4459, 11073, 7728, 8948, 2200, 9756, 6715, 4407, 2919, 7773, 10961, 3532, 9140, 121, 10497, 10577, 7912, 10554, 4512, 6848, 8642, 11212, 8417, 10691, 11486, 3014, 8597, 11497, 8629, 205, 7462, 3200, 7289, 1643, 11896, 3220, 10356, 4897, 3031, 4343, 7525, 11702, 11864, 5803, 3024, 10957, 8900, 3921, 11496, 11547, 7775, 506, 3047, 10497, 4177, 3342, 10287, 11552, 4930, 10825, 6818, 12245, 7602, 7988, 2443, 10833, 8396, 6519, 9099, 5303, 1788, 12239, 5744, 1984, 9728, 6311, 4108, 9675, 5766, 9317, 12055, 9146, 11615, 8332, 7691, 7744, 1247, 2115, 6085, 8157, 11708, 8072, 669, 785, 7749, 1793, 5969, 4524, 12085, 9068, 1066, 1347, 5365, 8480, 6866, 569, 9, 6836, 4610, 6543, 4954, 4225, 8700, 2425, 11925, 9114, 2184, 11271, 8420, 298, 3429, 1361, 965, 1639, 640, 89, 5306, 11015, 7004, 8221, 11695, 11481, 8465, 10702, 1937, 9796, 11981, 11623, 6859, 1161, 4788, 10414, 6701, 11842, 3143, 9611, 4696, 1533, 10988, 268, 10542, 5681, 9169, 1729, 3096, 7666, 5103, 6709, 7873, 4493, 3168, 9712, 3253, 3481, 9849, 11605, 11093, 2967, 4102, 9464, 11480, 12071, 8596, 6475, 10636, 958, 9578, 11397, 7509, 5990, 7893, 915, 7426, 1879, 6588, 3979, 3218, 4273, 12140, 9012, 3609, 10059, 10293, 10939, 8896, 7622, 7108, 2638, 9189, 1485, 11140, 2055, 6294, 603, 11152, 6833, 11792, 7549, 1779, 2338, 8692, 12142, 10670, 4283, 4643, 10843, 4930, 985, 1199, 7003, 5488, 5596, 454, 8518, 2876, 4345, 1341, 10082, 113, 7117, 11502, 3947, 1461, 7546, 655, 5128, 9003, 9577, 4797, 11020, 7339, 2666, 7922, 6762, 3086, 12027, 10147, 201, 8170, 6296, 11184, 9987, 6438, 11579, 1619, 9282, 5034, 8503, 1455, 3476, 5091, 8468, 8825, 9001, 12110, 4969, 4830, 482, 343, 3205, 11948, 6487, 5475, 264, 1719, 7618, 8589, 457, 10951, 2923, 6350, 4826, 396, 2933, 969, 6356, 1724, 10834, 11546, 5647, 2178, 9409, 10944, 3425, 7346, 10799, 2121, 1351, 2708, 4482, 49, 11064, 7328, 2739, 4846, 2440, 944, 3812, 6911, 517, 2049, 6849, 3678, 10041, 5025, 348, 3998, 7510, 273, 9620, 5667, 8687, 9298, 2073, 9512, 11324, 6786, 5606, 10429, 10326, 1963, 11206};

static const int16_t sig[] = {248, 161, -156, -225, 118, 301, 253, 92, 195, 92, -10, -13, 109, -101, 315, -60, -37, 142, -5, -175, -197, -316, -39, 113, -214, 158, -159, -206, 3, -226, -48, -190, -38, -67, 93, 251, -211, -65, 47, 136, -2, 168, 209, 125, 217, 259, -145, -22, -127, -169, -118, -68, 17, -84, -330, 46, 91, -98, -58, 69, -256, -93, -47, 46, 232, -441, 184, -241, -13, 258, -221, 213, 252, 52, 275, -143, -42, 52, 352, 220, -241, -98, -7, 132, 55, 315, 165, -148, -66, 219, -86, -14, 158, -20, 305, 46, -499, -88, -150, 186, 78, 24, -98, -171, 19, -189, 92, -63, -128, 108, -255, -41, 157, -64, -250, -198, -88, -189, -4, -195, -48, 178, -99, 104, 76, 163, 26, -105, -209, 147, -5, 184, -35, 8, 43, 191, -232, 207, -311, -4, -96, -10, -164, -236, -420, 91, 121, 15, 180, 121, 283, -72, 387, -45, -152, 120, 160, -93, -140, 392, 328, 368, 135, 160, -15, 150, -294, 251, -94, 151, 2, -61, -193, -304, 206, -124, -18, -157, 60, 103, -49, -210, -73, 52, -72, 92, 87, 392, 21, 418, -77, -28, -167, -104, -81, -52, 180, 106, 132, 38, 57, 89, -360, -393, -150, 219, 139, -134, 309, 211, 50, 53, -268, -19, 115, 92, -97, -116, -5, 136, -127, 45, -110, 242, -37, 300, 6, 20, 90, -120, 56, -25, 242, 19, 13, 124, 61, -206, -256, 334, 28, -70, -84, -154, 37, 182, 3, -116, 33, -271, -110, 196, 93, -153, 119, -122, 163, 148, -46, 307, 11, -5, 198, -253, 116, -16, 92, 66, 295, -98, -55, 141, -27, 230, 145, 143, 236, 356, 102, 110, 97, 90, -19, -67, -248, -289, 152, -242, -343, -189, 203, 258, -115, 167, -74, -130, -201, -61, 520, -318, -141, 88, 78, -166, -265, -127, 108, 67, 35, 208, -74, 60, 76, 236, -243, -119, -15, 413, -65, 154, 207, 48, 107, 325, 340, 262, -374, 273, 56, -134, 203, 173, 55, -401, 16, -78, -49, -118, -122, 57, -169, 60, -100, 162, -177, 100, 148, 2, 102, 19, 119, 47, 47, 4, -137, -148, -202, -168, -202, 74, -148, 41, -189, 162, 222, 91, 5, -232, 119, 222, 184, -191, -336, 112, 95, -19, -262, -277, -231, 267, -461, -294, -213, 357, 205, 62, 356, 260, -69, -188, 267, 6, -22, 38, -96, 59, -123, -26, -26, 125, -118, 105, 342, -14, 19, 198, -63, -6, -72, -87, 119, -274, -294, 249, -185, -152, 46, 208, 0, 54, 21, 185, 45, 55, 1, 185, -55, -205, -79, -66, 285, -51, -134, -46, -126, 13, 126, 11, 393, 167, 142, -183, -167, -79, -53, -89, 56, -52, 117, 25, 5, 63, -219, 103, -92, -26, 2, 223, -165, 388, -18, 129, -45, -6, 275, -180, 240, 119, 153, -190, -126, 289, -27, 42, 49, 30, -49, 243, 144, 21, -228, -124, -72, -96, -190, 73, -175, 72, 193, 159, 50, -64, 124, 26, 444, -126, 4, -178, -117, 114, 169, 18, -59, 201, -98, 264, 100, 121, -60, -33, 100, -122, 3093, 11131, 1969, 7903, 3546, 6688, 3256, 12227, 1776, 3893, 1933, 3057, 951, 11521, 719, 5559, 2616, 7485, 2520, 4324, 9304, 7297, 10463, 4857, 8218, 7575, 7753, 7063, 3290, 7809, 6643, 6415, 6168, 5521, 8683, 5876, 5951, 9355, 11329, 8713, 935, 7986, 7916, 1591, 11589, 7939, 5887, 3016, 9787, 11366, 8490, 7538, 433, 3414, 10220, 7056, 3179, 5340, 10901, 7777, 2082, 3979, 1192, 11983, 8507, 11934, 915, 12242, 11650, 3840, 10324, 4375, 7043, 289, 4424, 473, 9676, 7229, 6662, 2168, 12281, 8344, 4898, 10345, 6586, 3122, 11117, 5833, 8219, 1630, 93, 8995, 9687, 58, 8130, 3969, 10656, 4481, 3581, 10946, 8299, 3479, 2662, 61, 3069, 7167, 11329, 9986, 11176, 6853, 4429, 4624, 10060, 4998, 6071, 10090, 5265, 1050, 2195, 8081, 6276, 5464, 11946, 1265, 2383, 1370, 5571, 7463, 12161, 9127, 9037, 2829, 3078, 4343, 9717, 3301, 9306, 7389, 6107, 5894, 6124, 10037, 6505, 7188, 518, 1259, 1899, 5623, 11012, 11331, 5390, 11052, 10017, 9532, 10278, 2958, 1667, 8204, 9669, 10738, 10488, 2084, 5107, 1462, 8765, 6116, 8347, 3096, 747, 3440, 10906, 2331, 3130, 3111, 7493, 6192, 903, 10143, 2507, 10671, 5104, 538, 10426, 9834, 9820, 8320, 1424, 6485, 10669, 3753, 8721, 947, 9154, 561, 8433, 8717, 759, 6814, 4518, 9651, 7353, 1200, 196, 2140, 12062, 1650, 5464, 10724, 9791, 12052, 6030, 10314, 12255, 4768, 10626, 1509, 11058, 12080, 11296, 11598, 10647, 6789, 6516, 9975, 6578, 4190, 2511, 3661, 1056, 3026, 2373, 1333, 3093, 6790, 8405, 6499, 1205, 11558, 2596, 5950, 1562, 9067, 10073, 5803, 6192, 12033, 11471, 1968, 6715, 6481, 774, 6080, 9638, 10245, 2732, 4836, 3799, 242, 2233, 3719, 9532, 9466, 6542, 2627, 8503, 7180, 4286, 1635, 8831, 2862, 7370, 11325, 2045, 3126, 2514, 557, 6429, 3217, 11656, 2844, 8859, 6098, 7236, 4093, 7122, 5916, 10611, 10468, 6514, 1137, 3439, 7020, 4257, 6317, 5469, 5352, 4159, 10289, 1011, 3639, 8065, 7364, 10091, 4874, 7752, 10251, 8790, 4616, 2329, 4654, 5832, 12008, 530, 320, 2060, 12163, 8183, 2830, 3367, 674, 6130, 9503, 8067, 8714, 6638, 11828, 7543, 9209, 10420, 9538, 3926, 11817, 4521, 2270, 12116, 11013, 8317, 2654, 12134, 4488, 10843, 500, 4189, 5459, 6729, 2117, 4292, 838, 4037, 9316, 5600, 5300, 11891, 484, 7235, 7430, 6061, 3998, 1589, 6366, 2506, 1671, 5856, 10118, 9854, 7958, 9969, 2318, 1331, 9572, 7418, 9039, 6089, 4518, 3042, 11205, 5326, 11278, 1758, 11044, 3758, 3174, 11125, 9546, 320, 1465, 2547, 11154, 8562, 1418, 8197, 4394, 12216, 5223, 9970, 3548, 5317, 11775, 4952, 10997, 9311, 6515, 6885, 7880, 6755, 8491, 11244, 811, 8427, 252, 3062, 5349, 10338, 3354, 7906, 6092, 3125, 10299, 11224, 7630, 11273, 5614, 4165, 8113, 5089, 4451, 2721, 1151, 8399, 6275, 2365, 11162, 11117, 8111, 5902, 2401, 7206, 6112, 9985, 1326, 2992, 12122, 1554, 6617, 5074, 8810, 3362, 3154, 9733, 11506, 3382, 7882, 10243, 7362, 6095, 4183, 3725, 17, 562, 12279, 5268, 10427, 3714, 6757, 4296, 10396, 3993, 10299, 11414, 558, 10219, 10064, 499, 11226, 2163, 10550, 3678, 5743, 292, 11207, 6038, 6042, 2114, 1872, 2308, 11055, 3235, 4863, 2748, 1730, 5024, 12045, 2324, 6920, 8268, 8593, 6643, 4915, 781, 5747, 6542, 1641, 4534, 1742, 8329, 4529, 6869, 4822, 10665, 8760, 193, 10962};

static const uint16_t h[] = {11696, 10087, 9423, 8207, 7922, 89, 3391, 5263, 2994, 1892, 1876, 10868, 9498, 9522, 2535, 3804, 5320, 3440, 1029, 11177, 5369, 4562, 9622, 10200, 9328, 11786, 6952, 89, 10951, 11038, 5674, 11054, 530, 9118, 2519, 8410, 6677, 2027, 6571, 1377, 10851, 11102, 12152, 3914, 3146, 9282, 3870, 7490, 5961, 2646, 1996, 7850, 7597, 10420, 5250, 10036, 68, 9916, 3354, 11037, 2079, 5715, 2140, 10687, 10019, 3655, 6028, 419, 10417, 3375, 10334, 5859, 3711, 5382, 8853, 11340, 10788, 2063, 11778, 10583, 4553, 968, 8821, 6296, 2199, 1164, 7448, 7556, 4045, 951, 6230, 10995, 1730, 3683, 1136, 9016, 8542, 1768, 10446, 735, 7804, 8697, 4537, 8740, 8273, 2023, 8900, 4717, 8709, 11877, 3564, 6102, 7002, 6234, 6314, 3229, 2300, 4117, 11914, 6899, 956, 2575, 6908, 11157, 9528, 1122, 911, 5203, 4859, 7420, 978, 2733, 3041, 7828, 5987, 9608, 2412, 4092, 9594, 1645, 463, 7642, 11038, 4125, 1832, 11682, 7358, 9251, 10936, 8666, 9913, 2029, 2744, 5149, 4078, 1580, 5586, 9378, 1181, 3790, 4462, 1959, 1206, 4461, 799, 871, 4815, 10726, 11796, 4222, 8500, 398, 1465, 4952, 9932, 8719, 1933, 6480, 9746, 1055, 4459, 11073, 7728, 8948, 2200, 9756, 6715, 4407, 2919, 7773, 10961, 3532, 9140, 121, 10497, 10577, 7912, 10554, 4512, 6848, 8642, 11212, 8417, 10691, 11486, 3014, 8597, 11497, 8629, 205, 7462, 3200, 7289, 1643, 11896, 3220, 10356, 4897, 3031, 4343, 7525, 11702, 11864, 5803, 3024, 10957, 8900, 3921, 11496, 11547, 7775, 506, 3047, 10497, 4177, 3342, 10287, 11552, 4930, 10825, 6818, 12245, 7602, 7988, 2443, 10833, 8396, 6519, 9099, 5303, 1788, 12239, 5744, 1984, 9728, 6311, 4108, 9675, 5766, 9317, 12055, 9146, 11615, 8332, 7691, 7744, 1247, 2115, 6085, 8157, 11708, 8072, 669, 785, 7749, 1793, 5969, 4524, 12085, 9068, 1066, 1347, 5365, 8480, 6866, 569, 9, 6836, 4610, 6543, 4954, 4225, 8700, 2425, 11925, 9114, 2184, 11271, 8420, 298, 3429, 1361, 965, 1639, 640, 89, 5306, 11015, 7004, 8221, 11695, 11481, 8465, 10702, 1937, 9796, 11981, 11623, 6859, 1161, 4788, 10414, 6701, 11842, 3143, 9611, 4696, 1533, 10988, 268, 10542, 5681, 9169, 1729, 3096, 7666, 5103, 6709, 7873, 4493, 3168, 9712, 3253, 3481, 9849, 11605, 11093, 2967, 4102, 9464, 11480, 12071, 8596, 6475, 10636, 958, 9578, 11397, 7509, 5990, 7893, 915, 7426, 1879, 6588, 3979, 3218, 4273, 12140, 9012, 3609, 10059, 10293, 10939, 8896, 7622, 7108, 2638, 9189, 1485, 11140, 2055, 6294, 603, 11152, 6833, 11792, 7549, 1779, 2338, 8692, 12142, 10670, 4283, 4643, 10843, 4930, 985, 1199, 7003, 5488, 5596, 454, 8518, 2876, 4345, 1341, 10082, 113, 7117, 11502, 3947, 1461, 7546, 655, 5128, 9003, 9577, 4797, 11020, 7339, 2666, 7922, 6762, 3086, 12027, 10147, 201, 8170, 6296, 11184, 9987, 6438, 11579, 1619, 9282, 5034, 8503, 1455, 3476, 5091, 8468, 8825, 9001, 12110, 4969, 4830, 482, 343, 3205, 11948, 6487, 5475, 264, 1719, 7618, 8589, 457, 10951, 2923, 6350, 4826, 396, 2933, 969, 6356, 1724, 10834, 11546, 5647, 2178, 9409, 10944, 3425, 7346, 10799, 2121, 1351, 2708, 4482, 49, 11064, 7328, 2739, 4846, 2440, 944, 3812, 6911, 517, 2049, 6849, 3678, 10041, 5025, 348, 3998, 7510, 273, 9620, 5667, 8687, 9298, 2073, 9512, 11324, 6786, 5606, 10429, 10326, 1963, 11206, 10286, 794, 9440, 9567, 11847, 958, 11428, 12091, 4024, 5462, 1536, 1101, 4372, 2148, 963, 3713, 3221, 5234, 9399, 3009, 10808, 5331, 9013, 786, 2721, 7453, 9824, 11241, 10226, 11860, 9463, 7479, 11327, 5485, 6380, 4751, 7518, 10724, 10503, 7251, 11297, 1533, 1055, 3266, 4611, 6756, 501, 3928, 1255, 5206, 4405, 2609, 1708, 11927, 10322, 2187, 3611, 4294, 748, 12186, 7133, 2717, 2402, 11700, 7262, 11518, 5350, 4571, 6683, 10083, 3174, 1960, 550, 6415, 10104, 11212, 175, 1687, 5156, 5168, 3334, 9968, 5616, 5706, 10253, 3634, 2170, 460, 370, 724, 3990, 3977, 5986, 7291, 11859, 5252, 5316, 9337, 7279, 10190, 9186, 1674, 11030, 12203, 9528, 10197, 1199, 483, 11900, 5450, 9718, 5345, 6414, 11010, 9408, 5791, 5658, 1641, 3053, 9704, 4547, 2084, 2390, 4252, 7958, 2554, 6059, 4214, 8561, 2515, 9842, 7341, 9152, 1945, 6493, 8451, 10101, 6409, 7685, 7089, 9011, 4379, 61, 1709, 5962, 7171, 8875, 6622, 5333, 7519, 1307, 7827, 8367, 3883, 8699, 9756, 6032, 9455, 65535, 65535, 65535, 65535, 65535, 65535, 65535, 65535, 65535, 65535, 65535, 65535, 65535, 65535, 65535, 65535, 65535, 65535, 65535, 65535, 65535, 65535, 65535, 65535, 65535, 65535, 65535, 65535, 65535, 65535, 65535, 65535, 65535, 65535, 65535, 65535, 65535, 65535, 65535, 65535, 65535, 65535, 65535, 65535, 65535, 65535, 65535, 0, 0, 0, 3, 0, 0, 0, 7, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 49194, 0, 128, 0, 0, 0, 33280, 32676, 0, 0, 0, 0, 16428, 0, 128, 0, 0, 0, 0, 1, 512, 37480, 2703, 1, 0, 35328, 2703, 1, 0, 37456, 2703, 1, 0, 0, 33280, 32676, 0, 8, 0, 0, 0, 47520, 46453, 32759, 0, 3717, 5025, 32760, 0, 41992, 16395, 56138, 49243, 4096, 49152, 16384, 63167, 65535, 0, 0, 16424, 28672, 2702, 1, 0, 8, 0, 0, 0, 0, 0, 0, 0, 0, 0, 8, 0, 37480, 2703, 1, 0, 35328, 2703, 1, 0, 0, 0, 0, 0, 45952, 2702, 1, 0, 62488, 21825, 32760, 0, 4096, 0, 0, 0, 50944, 46453, 32759, 0, 0, 0, 0, 0, 28672, 2702, 1, 0, 47568, 46453, 32759, 0, 2002, 5025, 32760, 0, 62488, 21825, 32760, 0, 4096, 0, 0, 0, 1, 0, 0, 0, 32768, 21827, 32760, 0, 47632, 46453, 32759, 0, 47830, 5026, 32760, 0, 1, 0, 0, 0, 62488, 21825, 32760, 0, 2049, 0, 0, 0, 51080, 46453, 32759, 0, 4096, 0, 0, 0, 1, 0, 0, 0, 47712, 46453, 32759, 0, 29218, 5037, 32760, 0, 47696, 46453, 32759, 0, 12163, 5037, 32760, 0, 33280, 33280, 32676, 0, 7, 0, 0, 0, 0, 0, 0, 0, 62488, 21825, 32760, 0, 47744, 46453, 32759, 0, 3075, 5037, 32760, 0, 1, 0, 0, 0, 12030, 5044, 32760, 0, 1, 0, 0, 0, 47888, 46453, 32759, 0, 47824, 46453, 32759, 0, 17434, 5036, 32760, 0, 0, 0, 0, 0, 62488, 21825, 32760, 0, 0, 0, 0, 0, 47952, 46453, 32759, 0, 47824, 46453, 32759, 0, 3382, 5037, 32760, 0, 65535, 65535, 0, 0, 18584, 21828, 32760, 0, 47920, 46453, 32759, 0, 5770, 5039, 32760, 0, 47856, 46453, 32759, 0, 2, 0, 0, 0, 47948, 46453, 32759, 0, 39576, 2683, 1, 0};

/*
 * Table for NTT, binary case:
 *   GMb[x] = R*(g^rev(x)) mod q
 * where g = 7 (it is a 2048-th primitive root of 1 modulo q)
 * and rev() is the bit-reversal function over 10 bits.
 */
static const uint16_t GMb[] = {
    4091,  7888, 11060, 11208,  6960,  4342,  6275,  9759,
    1591,  6399,  9477,  5266,   586,  5825,  7538,  9710,
    1134,  6407,  1711,   965,  7099,  7674,  3743,  6442,
    10414,  8100,  1885,  1688,  1364, 10329, 10164,  9180,
    12210,  6240,   997,   117,  4783,  4407,  1549,  7072,
    2829,  6458,  4431,  8877,  7144,  2564,  5664,  4042,
    12189,   432, 10751,  1237,  7610,  1534,  3983,  7863,
    2181,  6308,  8720,  6570,  4843,  1690,    14,  3872,
    5569,  9368, 12163,  2019,  7543,  2315,  4673,  7340,
    1553,  1156,  8401, 11389,  1020,  2967, 10772,  7045,
    3316, 11236,  5285, 11578, 10637, 10086,  9493,  6180,
    9277,  6130,  3323,   883, 10469,   489,  1502,  2851,
    11061,  9729,  2742, 12241,  4970, 10481, 10078,  1195,
    730,  1762,  3854,  2030,  5892, 10922,  9020,  5274,
    9179,  3604,  3782, 10206,  3180,  3467,  4668,  2446,
    7613,  9386,   834,  7703,  6836,  3403,  5351, 12276,
    3580,  1739, 10820,  9787, 10209,  4070, 12250,  8525,
    10401,  2749,  7338, 10574,  6040,   943,  9330,  1477,
    6865,  9668,  3585,  6633, 12145,  4063,  3684,  7680,
    8188,  6902,  3533,  9807,  6090,   727, 10099,  7003,
    6945,  1949,  9731, 10559,  6057,   378,  7871,  8763,
    8901,  9229,  8846,  4551,  9589, 11664,  7630,  8821,
    5680,  4956,  6251,  8388, 10156,  8723,  2341,  3159,
    1467,  5460,  8553,  7783,  2649,  2320,  9036,  6188,
    737,  3698,  4699,  5753,  9046,  3687,    16,   914,
    5186, 10531,  4552,  1964,  3509,  8436,  7516,  5381,
    10733,  3281,  7037,  1060,  2895,  7156,  8887,  5357,
    6409,  8197,  2962,  6375,  5064,  6634,  5625,   278,
    932, 10229,  8927,  7642,   351,  9298,   237,  5858,
    7692,  3146, 12126,  7586,  2053, 11285,  3802,  5204,
    4602,  1748, 11300,   340,  3711,  4614,   300, 10993,
    5070, 10049, 11616, 12247,  7421, 10707,  5746,  5654,
    3835,  5553,  1224,  8476,  9237,  3845,   250, 11209,
    4225,  6326,  9680, 12254,  4136,  2778,   692,  8808,
    6410,  6718, 10105, 10418,  3759,  7356, 11361,  8433,
    6437,  3652,  6342,  8978,  5391,  2272,  6476,  7416,
    8418, 10824, 11986,  5733,   876,  7030,  2167,  2436,
    3442,  9217,  8206,  4858,  5964,  2746,  7178,  1434,
    7389,  8879, 10661, 11457,  4220,  1432, 10832,  4328,
    8557,  1867,  9454,  2416,  3816,  9076,   686,  5393,
    2523,  4339,  6115,   619,   937,  2834,  7775,  3279,
    2363,  7488,  6112,  5056,   824, 10204, 11690,  1113,
    2727,  9848,   896,  2028,  5075,  2654, 10464,  7884,
    12169,  5434,  3070,  6400,  9132, 11672, 12153,  4520,
    1273,  9739, 11468,  9937, 10039,  9720,  2262,  9399,
    11192,   315,  4511,  1158,  6061,  6751, 11865,   357,
    7367,  4550,   983,  8534,  8352, 10126,  7530,  9253,
    4367,  5221,  3999,  8777,  3161,  6990,  4130, 11652,
    3374, 11477,  1753,   292,  8681,  2806, 10378, 12188,
    5800, 11811,  3181,  1988,  1024,  9340,  2477, 10928,
    4582,  6750,  3619,  5503,  5233,  2463,  8470,  7650,
    7964,  6395,  1071,  1272,  3474, 11045,  3291, 11344,
    8502,  9478,  9837,  1253,  1857,  6233,  4720, 11561,
    6034,  9817,  3339,  1797,  2879,  6242,  5200,  2114,
    7962,  9353, 11363,  5475,  6084,  9601,  4108,  7323,
    10438,  9471,  1271,   408,  6911,  3079,   360,  8276,
    11535,  9156,  9049, 11539,   850,  8617,   784,  7919,
    8334, 12170,  1846, 10213, 12184,  7827, 11903,  5600,
    9779,  1012,   721,  2784,  6676,  6552,  5348,  4424,
    6816,  8405,  9959,  5150,  2356,  5552,  5267,  1333,
    8801,  9661,  7308,  5788,  4910,   909, 11613,  4395,
    8238,  6686,  4302,  3044,  2285, 12249,  1963,  9216,
    4296, 11918,   695,  4371,  9793,  4884,  2411, 10230,
    2650,   841,  3890, 10231,  7248,  8505, 11196,  6688,
    4059,  6060,  3686,  4722, 11853,  5816,  7058,  6868,
    11137,  7926,  4894, 12284,  4102,  3908,  3610,  6525,
    7938,  7982, 11977,  6755,   537,  4562,  1623,  8227,
    11453,  7544,   906, 11816,  9548, 10858,  9703,  2815,
    11736,  6813,  6979,   819,  8903,  6271, 10843,   348,
    7514,  8339,  6439,   694,   852,  5659,  2781,  3716,
    11589,  3024,  1523,  8659,  4114, 10738,  3303,  5885,
    2978,  7289, 11884,  9123,  9323, 11830,    98,  2526,
    2116,  4131, 11407,  1844,  3645,  3916,  8133,  2224,
    10871,  8092,  9651,  5989,  7140,  8480,  1670,   159,
    10923,  4918,   128,  7312,   725,  9157,  5006,  6393,
    3494,  6043, 10972,  6181, 11838,  3423, 10514,  7668,
    3693,  6658,  6905, 11953, 10212, 11922,  9101,  8365,
    5110,    45,  2400,  1921,  4377,  2720,  1695,    51,
    2808,   650,  1896,  9997,  9971, 11980,  8098,  4833,
    4135,  4257,  5838,  4765, 10985, 11532,   590, 12198,
    482, 12173,  2006,  7064, 10018,  3912, 12016, 10519,
    11362,  6954,  2210,   284,  5413,  6601,  3865, 10339,
    11188,  6231,   517,  9564, 11281,  3863,  1210,  4604,
    8160, 11447,   153,  7204,  5763,  5089,  9248, 12154,
    11748,  1354,  6672,   179,  5532,  2646,  5941, 12185,
    862,  3158,   477,  7279,  5678,  7914,  4254,   302,
    2893, 10114,  6890,  9560,  9647, 11905,  4098,  9824,
    10269,  1353, 10715,  5325,  6254,  3951,  1807,  6449,
    5159,  1308,  8315,  3404,  1877,  1231,   112,  6398,
    11724, 12272,  7286,  1459, 12274,  9896,  3456,   800,
    1397, 10678,   103,  7420,  7976,   936,   764,   632,
    7996,  8223,  8445,  7758, 10870,  9571,  2508,  1946,
    6524, 10158,  1044,  4338,  2457,  3641,  1659,  4139,
    4688,  9733, 11148,  3946,  2082,  5261,  2036, 11850,
    7636, 12236,  5366,  2380,  1399,  7720,  2100,  3217,
    10912,  8898,  7578, 11995,  2791,  1215,  3355,  2711,
    2267,  2004,  8568, 10176,  3214,  2337,  1750,  4729,
    4997,  7415,  6315, 12044,  4374,  7157,  4844,   211,
    8003, 10159,  9290, 11481,  1735,  2336,  5793,  9875,
    8192,   986,  7527,  1401,   870,  3615,  8465,  2756,
    9770,  2034, 10168,  3264,  6132,    54,  2880,  4763,
    11805,  3074,  8286,  9428,  4881,  6933,  1090, 10038,
    2567,   708,   893,  6465,  4962, 10024,  2090,  5718,
    10743,   780,  4733,  4623,  2134,  2087,  4802,   884,
    5372,  5795,  5938,  4333,  6559,  7549,  5269, 10664,
    4252,  3260,  5917, 10814,  5768,  9983,  8096,  7791,
    6800,  7491,  6272,  1907, 10947,  6289, 11803,  6032,
    11449,  1171,  9201,  7933,  2479,  7970, 11337,  7062,
    8911,  6728,  6542,  8114,  8828,  6595,  3545,  4348,
    4610,  2205,  6999,  8106,  5560, 10390,  9321,  2499,
    2413,  7272,  6881, 10582,  9308,  9437,  3554,  3326,
    5991, 11969,  3415, 12283,  9838, 12063,  4332,  7830,
    11329,  6605, 12271,  2044, 11611,  7353, 11201, 11582,
    3733,  8943,  9978,  1627,  7168,  3935,  5050,  2762,
    7496, 10383,   755,  1654, 12053,  4952, 10134,  4394,
    6592,  7898,  7497,  8904, 12029,  3581, 10748,  5674,
    10358,  4901,  7414,  8771,   710,  6764,  8462,  7193,
    5371,  7274, 11084,   290,  7864,  6827, 11822,  2509,
    6578,  4026,  5807,  1458,  5721,  5762,  4178,  2105,
    11621,  4852,  8897,  2856, 11510,  9264,  2520,  8776,
    7011,  2647,  1898,  7039,  5950, 11163,  5488,  6277,
    9182, 11456,   633, 10046, 11554,  5633,  9587,  2333,
    7008,  7084,  5047,  7199,  9865,  8997,   569,  6390,
    10845,  9679,  8268, 11472,  4203,  1997,     2,  9331,
    162,  6182,  2000,  3649,  9792,  6363,  7557,  6187,
    8510,  9935,  5536,  9019,  3706, 12009,  1452,  3067,
    5494,  9692,  4865,  6019,  7106,  9610,  4588, 10165,
    6261,  5887,  2652, 10172,  1580, 10379,  4638,  9949
};

/*
 * Table for inverse NTT, binary case:
 *   iGMb[x] = R*((1/g)^rev(x)) mod q
 * Since g = 7, 1/g = 8778 mod 12289.
 */
static const uint16_t iGMb[] = {
    4091,  4401,  1081,  1229,  2530,  6014,  7947,  5329,
    2579,  4751,  6464, 11703,  7023,  2812,  5890, 10698,
    3109,  2125,  1960, 10925, 10601, 10404,  4189,  1875,
    5847,  8546,  4615,  5190, 11324, 10578,  5882, 11155,
    8417, 12275, 10599,  7446,  5719,  3569,  5981, 10108,
    4426,  8306, 10755,  4679, 11052,  1538, 11857,   100,
    8247,  6625,  9725,  5145,  3412,  7858,  5831,  9460,
    5217, 10740,  7882,  7506, 12172, 11292,  6049,    79,
    13,  6938,  8886,  5453,  4586, 11455,  2903,  4676,
    9843,  7621,  8822,  9109,  2083,  8507,  8685,  3110,
    7015,  3269,  1367,  6397, 10259,  8435, 10527, 11559,
    11094,  2211,  1808,  7319,    48,  9547,  2560,  1228,
    9438, 10787, 11800,  1820, 11406,  8966,  6159,  3012,
    6109,  2796,  2203,  1652,   711,  7004,  1053,  8973,
    5244,  1517,  9322, 11269,   900,  3888, 11133, 10736,
    4949,  7616,  9974,  4746, 10270,   126,  2921,  6720,
    6635,  6543,  1582,  4868,    42,   673,  2240,  7219,
    1296, 11989,  7675,  8578, 11949,   989, 10541,  7687,
    7085,  8487,  1004, 10236,  4703,   163,  9143,  4597,
    6431, 12052,  2991, 11938,  4647,  3362,  2060, 11357,
    12011,  6664,  5655,  7225,  5914,  9327,  4092,  5880,
    6932,  3402,  5133,  9394, 11229,  5252,  9008,  1556,
    6908,  4773,  3853,  8780, 10325,  7737,  1758,  7103,
    11375, 12273,  8602,  3243,  6536,  7590,  8591, 11552,
    6101,  3253,  9969,  9640,  4506,  3736,  6829, 10822,
    9130,  9948,  3566,  2133,  3901,  6038,  7333,  6609,
    3468,  4659,   625,  2700,  7738,  3443,  3060,  3388,
    3526,  4418, 11911,  6232,  1730,  2558, 10340,  5344,
    5286,  2190, 11562,  6199,  2482,  8756,  5387,  4101,
    4609,  8605,  8226,   144,  5656,  8704,  2621,  5424,
    10812,  2959, 11346,  6249,  1715,  4951,  9540,  1888,
    3764,    39,  8219,  2080,  2502,  1469, 10550,  8709,
    5601,  1093,  3784,  5041,  2058,  8399, 11448,  9639,
    2059,  9878,  7405,  2496,  7918, 11594,   371,  7993,
    3073, 10326,    40, 10004,  9245,  7987,  5603,  4051,
    7894,   676, 11380,  7379,  6501,  4981,  2628,  3488,
    10956,  7022,  6737,  9933,  7139,  2330,  3884,  5473,
    7865,  6941,  5737,  5613,  9505, 11568, 11277,  2510,
    6689,   386,  4462,   105,  2076, 10443,   119,  3955,
    4370, 11505,  3672, 11439,   750,  3240,  3133,   754,
    4013, 11929,  9210,  5378, 11881, 11018,  2818,  1851,
    4966,  8181,  2688,  6205,  6814,   926,  2936,  4327,
    10175,  7089,  6047,  9410, 10492,  8950,  2472,  6255,
    728,  7569,  6056, 10432, 11036,  2452,  2811,  3787,
    945,  8998,  1244,  8815, 11017, 11218,  5894,  4325,
    4639,  3819,  9826,  7056,  6786,  8670,  5539,  7707,
    1361,  9812,  2949, 11265, 10301,  9108,   478,  6489,
    101,  1911,  9483,  3608, 11997, 10536,   812,  8915,
    637,  8159,  5299,  9128,  3512,  8290,  7068,  7922,
    3036,  4759,  2163,  3937,  3755, 11306,  7739,  4922,
    11932,   424,  5538,  6228, 11131,  7778, 11974,  1097,
    2890, 10027,  2569,  2250,  2352,   821,  2550, 11016,
    7769,   136,   617,  3157,  5889,  9219,  6855,   120,
    4405,  1825,  9635,  7214, 10261, 11393,  2441,  9562,
    11176,   599,  2085, 11465,  7233,  6177,  4801,  9926,
    9010,  4514,  9455, 11352, 11670,  6174,  7950,  9766,
    6896, 11603,  3213,  8473,  9873,  2835, 10422,  3732,
    7961,  1457, 10857,  8069,   832,  1628,  3410,  4900,
    10855,  5111,  9543,  6325,  7431,  4083,  3072,  8847,
    9853, 10122,  5259, 11413,  6556,   303,  1465,  3871,
    4873,  5813, 10017,  6898,  3311,  5947,  8637,  5852,
    3856,   928,  4933,  8530,  1871,  2184,  5571,  5879,
    3481, 11597,  9511,  8153,    35,  2609,  5963,  8064,
    1080, 12039,  8444,  3052,  3813, 11065,  6736,  8454,
    2340,  7651,  1910, 10709,  2117,  9637,  6402,  6028,
    2124,  7701,  2679,  5183,  6270,  7424,  2597,  6795,
    9222, 10837,   280,  8583,  3270,  6753,  2354,  3779,
    6102,  4732,  5926,  2497,  8640, 10289,  6107, 12127,
    2958, 12287, 10292,  8086,   817,  4021,  2610,  1444,
    5899, 11720,  3292,  2424,  5090,  7242,  5205,  5281,
    9956,  2702,  6656,   735,  2243, 11656,   833,  3107,
    6012,  6801,  1126,  6339,  5250, 10391,  9642,  5278,
    3513,  9769,  3025,   779,  9433,  3392,  7437,   668,
    10184,  8111,  6527,  6568, 10831,  6482,  8263,  5711,
    9780,   467,  5462,  4425, 11999,  1205,  5015,  6918,
    5096,  3827,  5525, 11579,  3518,  4875,  7388,  1931,
    6615,  1541,  8708,   260,  3385,  4792,  4391,  5697,
    7895,  2155,  7337,   236, 10635, 11534,  1906,  4793,
    9527,  7239,  8354,  5121, 10662,  2311,  3346,  8556,
    707,  1088,  4936,   678, 10245,    18,  5684,   960,
    4459,  7957,   226,  2451,     6,  8874,   320,  6298,
    8963,  8735,  2852,  2981,  1707,  5408,  5017,  9876,
    9790,  2968,  1899,  6729,  4183,  5290, 10084,  7679,
    7941,  8744,  5694,  3461,  4175,  5747,  5561,  3378,
    5227,   952,  4319,  9810,  4356,  3088, 11118,   840,
    6257,   486,  6000,  1342, 10382,  6017,  4798,  5489,
    4498,  4193,  2306,  6521,  1475,  6372,  9029,  8037,
    1625,  7020,  4740,  5730,  7956,  6351,  6494,  6917,
    11405,  7487, 10202, 10155,  7666,  7556, 11509,  1546,
    6571, 10199,  2265,  7327,  5824, 11396, 11581,  9722,
    2251, 11199,  5356,  7408,  2861,  4003,  9215,   484,
    7526,  9409, 12235,  6157,  9025,  2121, 10255,  2519,
    9533,  3824,  8674, 11419, 10888,  4762, 11303,  4097,
    2414,  6496,  9953, 10554,   808,  2999,  2130,  4286,
    12078,  7445,  5132,  7915,   245,  5974,  4874,  7292,
    7560, 10539,  9952,  9075,  2113,  3721, 10285, 10022,
    9578,  8934, 11074,  9498,   294,  4711,  3391,  1377,
    9072, 10189,  4569, 10890,  9909,  6923,    53,  4653,
    439, 10253,  7028, 10207,  8343,  1141,  2556,  7601,
    8150, 10630,  8648,  9832,  7951, 11245,  2131,  5765,
    10343,  9781,  2718,  1419,  4531,  3844,  4066,  4293,
    11657, 11525, 11353,  4313,  4869, 12186,  1611, 10892,
    11489,  8833,  2393,    15, 10830,  5003,    17,   565,
    5891, 12177, 11058, 10412,  8885,  3974, 10981,  7130,
    5840, 10482,  8338,  6035,  6964,  1574, 10936,  2020,
    2465,  8191,   384,  2642,  2729,  5399,  2175,  9396,
    11987,  8035,  4375,  6611,  5010, 11812,  9131, 11427,
    104,  6348,  9643,  6757, 12110,  5617, 10935,   541,
    135,  3041,  7200,  6526,  5085, 12136,   842,  4129,
    7685, 11079,  8426,  1008,  2725, 11772,  6058,  1101,
    1950,  8424,  5688,  6876, 12005, 10079,  5335,   927,
    1770,   273,  8377,  2271,  5225, 10283,   116, 11807,
    91, 11699,   757,  1304,  7524,  6451,  8032,  8154,
    7456,  4191,   309,  2318,  2292, 10393, 11639,  9481,
    12238, 10594,  9569,  7912, 10368,  9889, 12244,  7179,
    3924,  3188,   367,  2077,   336,  5384,  5631,  8596,
    4621,  1775,  8866,   451,  6108,  1317,  6246,  8795,
    5896,  7283,  3132, 11564,  4977, 12161,  7371,  1366,
    12130, 10619,  3809,  5149,  6300,  2638,  4197,  1418,
    10065,  4156,  8373,  8644, 10445,   882,  8158, 10173,
    9763, 12191,   459,  2966,  3166,   405,  5000,  9311,
    6404,  8986,  1551,  8175,  3630, 10766,  9265,   700,
    8573,  9508,  6630, 11437, 11595,  5850,  3950,  4775,
    11941,  1446,  6018,  3386, 11470,  5310,  5476,   553,
    9474,  2586,  1431,  2741,   473, 11383,  4745,   836,
    4062, 10666,  7727, 11752,  5534,   312,  4307,  4351,
    5764,  8679,  8381,  8187,     5,  7395,  4363,  1152,
    5421,  5231,  6473,   436,  7567,  8603,  6229,  8230
};
/* ===================================================================== */


/*
 * Addition modulo q. Operands must be in the 0..q-1 range.
 */
static inline uint32_t
mq_add(uint32_t x, uint32_t y) {
    /*
     * We compute x + y - q. If the result is negative, then the
     * high bit will be set, and 'd >> 31' will be equal to 1;
     * thus '-(d >> 31)' will be an all-one pattern. Otherwise,
     * it will be an all-zero pattern. In other words, this
     * implements a conditional addition of q.
     */
    uint32_t d;

    d = x + y - Q;
    d += Q & -(d >> 31);
    return d;
}


/*
 * Subtraction modulo q. Operands must be in the 0..q-1 range.
 */
static inline uint32_t
mq_sub(uint32_t x, uint32_t y) {
    /*
     * As in mq_add(), we use a conditional addition to ensure the
     * result is in the 0..q-1 range.
     */
    uint32_t d;

    d = x - y;
    d += Q & -(d >> 31);
    return d;
}


/*
 * Division by 2 modulo q. Operand must be in the 0..q-1 range.
 */
static inline uint32_t
mq_rshift1(uint32_t x) {
    x += Q & -(x & 1);
    return (x >> 1);
}


/*
 * Subtract polynomial g from polynomial f.
 */
static void
mq_poly_sub(uint16_t *f, const uint16_t *g, unsigned logn) {
    size_t u, n;

    n = (size_t)1 << logn;
    for (u = 0; u < n; u ++) {
        f[u] = (uint16_t)mq_sub(f[u], g[u]);
    }
}


/*
 * Montgomery multiplication modulo q. If we set R = 2^16 mod q, then
 * this function computes: x * y / R mod q
 * Operands must be in the 0..q-1 range.
 */
static inline uint32_t
mq_montymul(uint32_t x, uint32_t y) {
    uint32_t z, w;

    /*
     * We compute x*y + k*q with a value of k chosen so that the 16
     * low bits of the result are 0. We can then shift the value.
     * After the shift, result may still be larger than q, but it
     * will be lower than 2*q, so a conditional subtraction works.
     */

    z = x * y;
    w = ((z * Q0I) & 0xFFFF) * Q;

    /*
     * When adding z and w, the result will have its low 16 bits
     * equal to 0. Since x, y and z are lower than q, the sum will
     * be no more than (2^15 - 1) * q + (q - 1)^2, which will
     * fit on 29 bits.
     */
    z = (z + w) >> 16;

    /*
     * After the shift, analysis shows that the value will be less
     * than 2q. We do a subtraction then conditional subtraction to
     * ensure the result is in the expected range.
     */
    z -= Q;
    z += Q & -(z >> 31);
    return z;
}


/*
 * Multiply two polynomials together (NTT representation, and using
 * a Montgomery multiplication). Result f*g is written over f.
 */
static void
mq_poly_montymul_ntt(uint16_t *f, const uint16_t *g, unsigned logn) {
    size_t u, n;

    n = (size_t)1 << logn;
    for (u = 0; u < n; u ++) {
        f[u] = (uint16_t)mq_montymul(f[u], g[u]);
    }
}


/*
 * Compute NTT on a ring element.
 */
static void
mq_NTT(uint16_t *a, unsigned logn) {
    size_t n, t, m;

    n = (size_t)1 << logn;
    t = n;
    for (m = 1; m < n; m <<= 1) {
        size_t ht, i, j1;

        ht = t >> 1;
        for (i = 0, j1 = 0; i < m; i ++, j1 += t) {
            size_t j, j2;
            uint32_t s;

            s = GMb[m + i];
            j2 = j1 + ht;
            for (j = j1; j < j2; j ++) {
                uint32_t u, v;

                u = a[j];
                v = mq_montymul(a[j + ht], s);
                a[j] = (uint16_t)mq_add(u, v);
                a[j + ht] = (uint16_t)mq_sub(u, v);
            }
        }
        t = ht;
    }
}


/*
 * Compute the inverse NTT on a ring element, binary case.
 */
static void
mq_iNTT(uint16_t *a, unsigned logn) {
    size_t n, t, m;
    uint32_t ni;

    n = (size_t)1 << logn;
    t = 1;
    m = n;
    while (m > 1) {
        size_t hm, dt, i, j1;

        hm = m >> 1;
        dt = t << 1;
        for (i = 0, j1 = 0; i < hm; i ++, j1 += dt) {
            size_t j, j2;
            uint32_t s;

            j2 = j1 + t;
            s = iGMb[hm + i];
            for (j = j1; j < j2; j ++) {
                uint32_t u, v, w;

                u = a[j];
                v = a[j + t];
                a[j] = (uint16_t)mq_add(u, v);
                w = mq_sub(u, v);
                a[j + t] = (uint16_t)
                           mq_montymul(w, s);
            }
        }
        t = dt;
        m = hm;
    }

    /*
     * To complete the inverse NTT, we must now divide all values by
     * n (the vector size). We thus need the inverse of n, i.e. we
     * need to divide 1 by 2 logn times. But we also want it in
     * Montgomery representation, i.e. we also want to multiply it
     * by R = 2^16. In the common case, this should be a simple right
     * shift. The loop below is generic and works also in corner cases;
     * its computation time is negligible.
     */
    ni = R;
    for (m = n; m > 1; m >>= 1) {
        ni = mq_rshift1(ni);
    }
    for (m = 0; m < n; m ++) {
        a[m] = (uint16_t)mq_montymul(a[m], ni);
    }
}


/*
 * Tell whether a given vector (2N coordinates, in two halves) is
 * acceptable as a signature. This compares the appropriate norm of the
 * vector with the acceptance bound. Returned value is 1 on success
 * (vector is short enough to be acceptable), 0 otherwise.
 */
static int
PQCLEAN_FALCON512_CLEAN_is_short(
    const int16_t *s1, const int16_t *s2, unsigned logn) {
    /*
     * We use the l2-norm. Code below uses only 32-bit operations to
     * compute the square of the norm with saturation to 2^32-1 if
     * the value exceeds 2^31-1.
     */
    size_t n, u;
    uint32_t s, ng;

    n = (size_t)1 << logn;
    s = 0;
    ng = 0;
    for (u = 0; u < n; u ++) {
        int32_t z;

        z = s1[u];
        s += (uint32_t)(z * z);
        ng |= s;
        z = s2[u];
        s += (uint32_t)(z * z);
        ng |= s;
    }
    s |= -(ng >> 31);

    /*
     * Acceptance bound on the l2-norm is:
     *   1.2*1.55*sqrt(q)*sqrt(2*N)
     * Value 7085 is floor((1.2^2)*(1.55^2)*2*1024).
     */
    return s < (((uint32_t)7085 * (uint32_t)12289) >> (10 - logn));
}


// /*
 // * Convert a public key to NTT + Montgomery format. Conversion is done
 // * in place.
 // */
// static void
// PQCLEAN_FALCON512_CLEAN_to_ntt_monty(uint16_t *h, unsigned logn) {
// mq_NTT(h, logn);
// mq_poly_tomonty(h, logn);
// }

/* Internal signature verification code:
 *   c0[]      contains the hashed nonce+message
 *   s2[]      is the decoded signature
 *   h[]       contains the public key, in NTT + Montgomery format
 *   logn      is the degree log
 *   tmp[]     temporary, must have at least 2*2^logn bytes
 * Returned value is 1 on success, 0 on error.
 *
 * tmp[] must have 16-bit alignment.
 */
static int
PQCLEAN_FALCON512_CLEAN_verify_raw(const uint16_t *c0, const int16_t *s2,
                                   const uint16_t *h, unsigned logn, uint8_t *tmp) {
    size_t u, n;
    uint16_t *tt;

    n = (size_t)1 << logn;
    tt = (uint16_t *)tmp;

    /*
     * Reduce s2 elements modulo q ([0..q-1] range).
     */
    for (u = 0; u < n; u ++) {
        uint32_t w;

        w = (uint32_t)s2[u];
        w += Q & -(w >> 31);
        tt[u] = (uint16_t)w;
    }

    /*
     * Compute -s1 = s2*h - c0 mod phi mod q (in tt[]).
     */
    mq_NTT(tt, logn);
    mq_poly_montymul_ntt(tt, h, logn);
    mq_iNTT(tt, logn);
    mq_poly_sub(tt, c0, logn);

    /*
     * Normalize -s1 elements into the [-q/2..q/2] range.
     */
    for (u = 0; u < n; u ++) {
        int32_t w;

        w = (int32_t)tt[u];
        w -= (int32_t)(Q & -(((Q >> 1) - (uint32_t)w) >> 31));
        ((int16_t *)tt)[u] = (int16_t)w;
    }

    /*
     * Signature is valid if and only if the aggregate (-s1,s2) vector
     * is short enough.
     */
    return PQCLEAN_FALCON512_CLEAN_is_short((int16_t *)tt, s2, logn);
}


int main(void) {
  uint8_t tmp[FALCON_KEYGEN_TEMP_9];

  // verify the message
  int32_t verify = PQCLEAN_FALCON512_CLEAN_verify_raw(hm, sig, h, 9, tmp);
  if (verify == 1) {
    printf("ok\n");
  } else {
    printf("failed to verify\n");
  }

  return 0;
}
